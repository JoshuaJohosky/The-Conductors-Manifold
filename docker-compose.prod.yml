# Production Docker Compose with Nginx Reverse Proxy
# The Conductor's Manifold - Secure Remote Access Configuration
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# This overrides the development setup with production-ready configuration:
# - Nginx reverse proxy on port 80 (and 443 for HTTPS)
# - Rate limiting on API endpoints
# - WebSocket support for real-time updates
# - Security headers and SSL termination

version: '3.8'

services:
  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: conductors-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      # Mount SSL certificates (uncomment and configure for HTTPS)
      # - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - backend
      - frontend
    networks:
      - manifold-network
    restart: unless-stopped

  # Backend (production overrides)
  backend:
    # Remove port exposure - access only through nginx
    ports: []
    environment:
      - DATABASE_URL=postgresql://manifold:manifold@postgres:5432/manifold_db
      - REDIS_URL=redis://redis:6379
      - ALPHAVANTAGE_API_KEY=${ALPHAVANTAGE_API_KEY}
      - BINANCE_API_KEY=${BINANCE_API_KEY:-}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET:-}
      - SECRET_KEY=${SECRET_KEY}
      - CONDUCTOR_API_KEY=${CONDUCTOR_API_KEY}
      - ENVIRONMENT=production
      - API_HOST=0.0.0.0
      - API_PORT=8000
    # Production command (no reload)
    command: uvicorn backend.api.main:app --host 0.0.0.0 --port 8000 --workers 2
    restart: unless-stopped
    networks:
      - manifold-network

  # Frontend (production overrides)
  frontend:
    # Remove port exposure - access only through nginx
    ports: []
    environment:
      # Point to nginx (internal docker network)
      - REACT_APP_API_URL=/api
      - REACT_APP_WS_URL=/ws
      - NODE_ENV=production
    # Production build
    command: npm run build && npx serve -s build -l 3000
    restart: unless-stopped
    networks:
      - manifold-network

  # PostgreSQL (production settings)
  postgres:
    environment:
      - POSTGRES_USER=manifold
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-manifold}
      - POSTGRES_DB=manifold_db
    ports: []  # No external access
    restart: unless-stopped
    networks:
      - manifold-network

  # Redis (production settings)
  redis:
    ports: []  # No external access
    restart: unless-stopped
    networks:
      - manifold-network

  # Prometheus (production settings)
  prometheus:
    ports: []  # Access only through nginx or internal network
    restart: unless-stopped
    networks:
      - manifold-network

  # Grafana (production settings)
  grafana:
    ports: []  # Access through nginx subdomain/path if needed
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_SERVER_ROOT_URL=%(protocol)s://%(domain)s/grafana/
    restart: unless-stopped
    networks:
      - manifold-network

networks:
  manifold-network:
    driver: bridge

# Note: Volumes are inherited from docker-compose.yml
